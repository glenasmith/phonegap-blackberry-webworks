<project default="help">
    
        <!-- LOAD PROPERTIES -->
    
    <property prefix="properties" file="project.properties" />
    <property name="build.dir"    location="build" />
    <property name="widget.dir"   location="${build.dir}/widget" />
    <property name="code.sign"    value="false" />
    <property name="generate.ext"   value="cod" />
    
    
    <!-- BlackBerry WebWorks Packager directory is required. -->
    <fail unless="properties.playbook.bbwp.dir" message="Please specify BlackBerry WebWorks Packager directory using 'bbwp.dir' in your 'project.properties' file." />

    <!-- LOAD DEVICE -->
    
    <target name="load-device" depends="package-app">
        <bbwp code-sign="false" />

        <exec executable="cmd" dir="." failonerror="true">
            <arg value="/c"/>
            <arg value="${properties.playbook.bbwp.dir}\blackberry-tablet-sdk\bin\blackberry-deploy.bat"/>
            <arg value="-installApp" />
            <arg value="-launchApp" />
            <arg value="-device" />
            <arg value="${properties.playbook.device.ip}" />
            <arg value="-password" />
            <arg value="${properties.playbook.device.password}" />
            <arg file="${build.dir}/${cod.name}.bar" />
        </exec>
    </target>
    
    <!-- LOAD SIMULATOR -->
    
    <target name="load-simulator" depends="build">

        <!-- Locate BBWP simulator directory. There may be multiple, so choose the first. -->
        <path id="bbwp.sim.path">
            <first>
                <fileset dir="${properties.playbook.bbwp.dir}/simpack">
                    <include name="**/handhelds.manifest.txt" />
                </fileset>
            </first>
        </path>
        <dirname property="bbwp.sim.dir" file="${toString:bbwp.sim.path}" />

        <!-- Simulator directory: Use sim.dir property if set in project.properties file. 
             Otherwise, use bbwp simulator directory. -->
        <condition 
            property="simulator.dir" 
            value="${properties.blackberry.sim.dir}" 
            else="${bbwp.sim.dir}">
                <available file="${properties.blackberry.sim.dir}" type="dir" />
        </condition>
        <echo message="Simulator directory=${simulator.dir}" />

        <!-- Simulator binary: Use sim.bin property if set in project.properties file  
             or try setting to 'defaultSimulator.bat' in simulator directory. -->
        <condition 
            property="sim.bin" 
            value="${properties.blackberry.sim.bin}" 
            else="defaultSimulator.bat">
                <available file="${simulator.dir}/${properties.blackberry.sim.bin}"/>
        </condition>

        <!-- If simulator executable does not exist, use the first device listed 
             in the 'handhelds.manifest.txt' file in the simulator directory. -->
        <loadfile 
            property="device.list"
            srcFile="${simulator.dir}/handhelds.manifest.txt">
            <filterchain>
                <tokenFilter>
                    <stringtokenizer/>
                </tokenFilter>
            </filterchain>
        </loadfile>

        <propertyregex property="device"
            input="${device.list}"
            regexp="^\d{4}"
            select="\0"
            override="true" />
        <property name="device.bin" value="${device}.bat" />

        <condition
            property="simulator.bin" 
            value="${sim.bin}"
            else="${device.bin}">
                <available file="${simulator.dir}/${sim.bin}" />
        </condition>
        
        <echo message="Simulator executable=${simulator.dir}/${simulator.bin}" />

        <!-- Close running simulators -->
        <echo message="Closing all running simulators..." />
        <exec executable="${simulator.dir}/fledgecontroller.exe" dir="${simulator.dir}" spawn="false">
            <arg value="/execute=kill" />
        </exec>

        <!-- MDS directory: Use mds.dir property if set in project.properties file. 
             Otherwise, use bbwp MDS directory. -->
        <condition 
            property="mds.dir" 
            value="${properties.blackberry.mds.dir}" 
            else="${properties.playbook.bbwp.dir}/mds">
                <available file="${properties.blackberry.mds.dir}" type="dir" />
        </condition>
        <echo message="MDS directory=${mds.dir}" />
        
        <copy todir="${simulator.dir}">
            <fileset dir="${build.dir}/StandardInstall" includes="*.cod, *.cso, *.csl, *.alx" />
        </copy>
        <exec executable="${mds.dir}/run.bat" dir="${mds.dir}" spawn="true" />
        <exec executable="${simulator.dir}/${simulator.bin}" dir="${simulator.dir}" spawn="true" />

        <!-- Only invoke FledgeHook.exe if it is found. Newer versions of the
             WebWorks SDK do not include it. -->
        <if>
            <available file="${properties.playbook.bbwp.dir}/FledgeHook.exe" />
            <then>
                <exec executable="${properties.playbook.bbwp.dir}/FledgeHook.exe" dir="${properties.playbook.bbwp.dir}" spawn="true" />
            </then>
        </if>
    </target>
    
    <!-- PACKAGE-APP -->
    
    <target name="package-app" depends="generate-cod-name, clean">
        <!-- Copy the WebWorks application -->
        <mkdir dir="${widget.dir}" />
        <copy todir="${widget.dir}" overwrite="true">
            <fileset dir="www" >
                <exclude name="ext/**"/>
                <exclude name="ext-air/**"/>
                <exclude name="playbook/**"/>
            </fileset>
        </copy>
        
        <!-- Overwrite the phonegap js with the playbook specific phonegap js -->
        <copy todir="${widget.dir}" overwrite="true">
            <fileset dir="www/playbook">
                <include name="*.js" />
            </fileset>
        </copy>
        
        <!-- Update WebWorks Packager with the AIR APIs -->
        <copy todir="${properties.playbook.bbwp.dir}\ext" overwrite="true">
            <fileset dir="www/ext-air" excludes="README.md" />
        </copy>
        
        <!-- Package the WebWorks app by zipping the widget dir. -->
        <mkdir dir="${build.dir}" />
        <zip compress="false" destfile="${build.dir}/${cod.name}.zip" basedir="${widget.dir}" excludes="**/build/**,**/.settings/**,**/.project" />
    </target>
    
    <!-- BUILD -->

    <target name="build" depends="package-app">
        <bbwp code-sign="${code.sign}" />
    </target>

    <!-- BBWP MACRO -->

    <macrodef name="bbwp">
        <attribute name="code-sign" default="false" />
        <sequential>

            <!-- Ensure bbwp executable exists. -->
            <property name="properties.playbook.bbwp.bin" location="${properties.playbook.bbwp.dir}/bbwp.exe" />
            <available file="${properties.playbook.bbwp.bin}" property="properties.playbook.bbwp.exists" />
            <fail unless="properties.playbook.bbwp.exists" message="Cannot find ${properties.playbook.bbwp.bin}. Please edit 'bbwp.dir' in your 'project.properties' file." />

            <if>
                <equals arg1="@{code-sign}" arg2="true" />
                <then>
                    <exec executable="${properties.playbook.bbwp.bin}">
                        <arg file="${build.dir}/${cod.name}.zip" />
                        <arg value="-g" />
                        <arg value="${properties.blackberry.sigtool.password}" />
                        <arg value="-o" />
                        <arg file="${build.dir}" />
                    </exec>
                </then>
                <else>
                    <exec executable="${properties.playbook.bbwp.bin}">
                        <arg file="${build.dir}/${cod.name}.zip" />
                        <arg value="-o" />
                        <arg file="${build.dir}" />
                        <arg value="-d" />
                    </exec>
                </else>
            </if>
        </sequential>
    </macrodef>

    <!-- CLEAN -->
    
    <target name="clean">
        <delete dir="${build.dir}" />
        <delete dir="${widget.dir}" />
    </target>
    
    <!-- CLEAN DEVICE -->
    
    <target name="clean-device" depends="generate-cod-name">
        <exec executable="${properties.playbook.bbwp.dir}/bin/JavaLoader.exe">
            <arg value="-usb" />
            <arg value="erase" />
            <arg value="-f" />
            <arg value="${cod.name}.cod" />
        </exec>
    </target>
    
    <!-- CLEAN SIMULATOR -->
    
    <target name="clean-simulator">
        <exec executable="${simulator.dir}/clean.bat" dir="${simulator.dir}" />
        
        <delete>
            <fileset dir="${simulator.dir}" includes="*.cod,*.csl,*.cso,*.debug,*.jar" />
        </delete>
    </target>
    
        <!-- HELPER TASKS -->
    
    <target name="generate-cod-name">
        <xmlproperty file="www/config.xml" prefix="config.xml" />
        <propertyregex property="cod.name"
                       input="${config.xml.widget.name}"
                       regexp="(\W+)"
                       replace=""
                       casesensitive="false"
                       global="true"
                       defaultValue="${config.xml.widget.name}" />        
        <echo message="Generated name: ${cod.name}.bar" />
    </target>
    
</project>